<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-weight: 500; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { text-align: center; margin-top: 15px; font-weight: bold; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è Select2 (–ø–æ–∏—Å–∫) */
        .select2-container .select2-selection--single { height: 45px; border: 1px solid #ddd; border-radius: 8px; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 45px; padding-left: 12px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 45px; }
        .order-id-display { text-align: center; color: #888; font-size: 0.9em; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöö –î–∞–Ω—ñ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
    <div class="order-id-display" id="orderIdDisplay">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <form id="deliveryForm">
        <div class="form-group">
            <label>–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ –±–∞—Ç—å–∫–æ–≤—ñ</label>
            <input type="text" id="fio" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤–∏—á" required>
        </div>

        <div class="form-group">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="phone" placeholder="0501234567" required>
        </div>

        <div class="form-group">
            <label>–ú—ñ—Å—Ç–æ (–ø–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏)</label>
            <select id="citySelect" style="width: 100%;" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ...</option>
            </select>
        </div>

        <div class="form-group">
            <label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
            <select id="branchSelect" style="width: 100%;" disabled required>
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
            </select>
        </div>

        <button type="submit" id="submitBtn">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –¥–∞–Ω—ñ</button>
    </form>
    <div id="statusMessage" class="status"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π URL –æ—Ç Cloudflare Workers
    const WORKER_URL = 'https://crm-facebook.brelok2023.workers.dev'; 
    
    // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ API –ö–ª—é—á –ù–æ–≤–æ–π –ü–æ—á—Ç—ã (—Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
    const NP_API_KEY = '66885fa6c73156f763104583f3ae6302'; 

    // --- –õ–û–ì–ò–ö–ê ---
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Ref –∫–æ–¥–æ–≤ (–Ω—É–∂–Ω—ã –¥–ª—è –¢–¢–ù)
    let selectedCityRef = '';
    let selectedBranchRef = '';

    $(document).ready(function() {
        if (!orderId) {
            document.body.innerHTML = '<h2 style="text-align:center; margin-top:50px;">‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ–≤—ñ—Ä–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (–Ω–µ–º–∞—î ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è).</h2>';
            return;
        }
        $('#orderIdDisplay').text(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ: ${orderId}`);

        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –ì–û–†–û–î–ê (Select2 + NP API)
        $('#citySelect').select2({
            placeholder: "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞...",
            minimumInputLength: 2,
            language: { inputTooShort: () => "–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± 2 –ª—ñ—Ç–µ—Ä–∏ –¥–ª—è –ø–æ—à—É–∫—É..." },
            ajax: {
                url: 'https://api.novaposhta.ua/v2.0/json/',
                type: 'POST',
                dataType: 'json',
                delay: 500, // –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏
                data: function (params) {
                    return JSON.stringify({
                        apiKey: NP_API_KEY,
                        modelName: "Address",
                        calledMethod: "searchSettlements",
                        methodProperties: {
                            CityName: params.term,
                            Limit: "20",
                            Page: "1"
                        }
                    });
                },
                processResults: function (data) {
                    if (data.success && data.data[0]) {
                        return {
                            results: data.data[0].Addresses.map(item => ({
                                id: item.DeliveryCity, // –°–æ—Ö—Ä–∞–Ω—è–µ–º Ref –≥–æ—Ä–æ–¥–∞
                                text: `${item.Present}`, // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
                                cityRef: item.DeliveryCity // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                            }))
                        };
                    }
                    return { results: [] };
                }
            }
        });

        // 2. –ö–æ–≥–¥–∞ –≥–æ—Ä–æ–¥ –≤—ã–±—Ä–∞–Ω -> –ì—Ä—É–∑–∏–º –û–¢–î–ï–õ–ï–ù–ò–Ø
        $('#citySelect').on('select2:select', function (e) {
            selectedCityRef = e.params.data.id; // Ref –≥–æ—Ä–æ–¥–∞
            $('#branchSelect').prop('disabled', true).empty().append('<option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>');
            
            // –ó–∞–ø—Ä–æ—Å –æ—Ç–¥–µ–ª–µ–Ω–∏–π
            fetch('https://api.novaposhta.ua/v2.0/json/', {
                method: 'POST',
                body: JSON.stringify({
                    apiKey: NP_API_KEY,
                    modelName: "Address",
                    calledMethod: "getWarehouses",
                    methodProperties: {
                        CityRef: selectedCityRef,
                    }
                })
            })
            .then(res => res.json())
            .then(response => {
                $('#branchSelect').empty().append('<option value="">–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è...</option>');
                if(response.success) {
                    response.data.forEach(branch => {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ—á—Ç–æ–º–∞—Ç—ã, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å (CategoryOfWarehouse)
                        // –°–µ–π—á–∞—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
                        $('#branchSelect').append(`<option value="${branch.Ref}">${branch.Description}</option>`);
                    });
                    $('#branchSelect').prop('disabled', false).select2();
                }
            });
        });

        // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Ref –æ—Ç–¥–µ–ª–µ–Ω–∏—è
        $('#branchSelect').on('change', function() {
            selectedBranchRef = $(this).val();
        });

        // 4. –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–•
        $('#deliveryForm').on('submit', async function(e) {
            e.preventDefault();
            const btn = $('#submitBtn');
            const status = $('#statusMessage');
            
            btn.prop('disabled', true).text('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...');
            status.text('');

            const payload = {
                action: 'update_delivery', // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –í–æ—Ä–∫–µ—Ä–∞
                order_id: orderId,
                fio: $('#fio').val().trim(),
                phone: $('#phone').val().trim(),
                city: $('#citySelect option:selected').text(), // –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
                branch: $('#branchSelect option:selected').text(), // –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è
                ref_data: {
                    city_ref: selectedCityRef,
                    branch_ref: selectedBranchRef
                }
            };

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    document.body.innerHTML = `
                        <div class="container" style="text-align:center;">
                            <h1 style="color:green; font-size: 50px;">‚úÖ</h1>
                            <h2>–î—è–∫—É—î–º–æ!</h2>
                            <p>–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ.</p>
                            <p>–ú–∏ –≤–∂–µ –≥–æ—Ç—É—î–º–æ –≤–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.</p>
                        </div>
                    `;
                } else {
                    status.css('color', 'red').text('–ü–æ–º–∏–ª–∫–∞: ' + result.message);
                    btn.prop('disabled', false).text('–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑');
                }
            } catch (error) {
                status.css('color', 'red').text('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                btn.prop('disabled', false).text('–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑');
            }
        });
    });
</script>

</body>
</html>
